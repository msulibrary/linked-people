<?php
//declare content type before any text is sent to browser
header('Content-type: application/rdf+xml');

//make XML declaration
echo ("<?xml version=\"1.0\" encoding=\"utf-8\"?>\n");

//get and set url protocol
$protocol = (!empty($_SERVER['HTTPS']) && $_SERVER['HTTPS'] !== 'off' || $_SERVER['SERVER_PORT'] == 443) ? 'https://' : 'http://';
//set and sanitize global variables for URL construction
$server = isset($_SERVER['SERVER_NAME']) ? htmlentities(strip_tags($_SERVER['SERVER_NAME'])) : null;
$path = isset($_SERVER['PHP_SELF']) ? htmlentities(strip_tags(dirname($_SERVER['PHP_SELF']))) : null;
$fileName = isset($_SERVER['SCRIPT_NAME']) ? htmlentities(strip_tags(basename($_SERVER['SCRIPT_NAME']))) : null;
$fileNameURI = isset($_SERVER['REQUEST_URI']) ? htmlentities(strip_tags($_SERVER['REQUEST_URI'])) : null;
$fileExtension = isset($_SERVER['PATH_INFO']) ? pathinfo($fileName, PATHINFO_EXTENSION) : null;

//pass database parameters and connect to database
include_once './meta/assets/database-params.inc';

//check if the $id variable was passed in url, escape the string for mysql, and validate that it is a numeric value - pass id value to select record
if (isset($_GET['id']) and is_numeric($_GET['id'])) {
  $id = strip_tags($connectLibstaff->real_escape_string((int)$_GET['id']));
} else {
  echo 'Query type not supported.';
  exit;
}
?>
<rdf:RDF
  xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#"
  xmlns:schema="http://schema.org/"
	xmlns:owl="http://www.w3.org/2002/07/owl#"
	xmlns:dbo="http://dbpedia.org/ontology/"
>
<?php
//request selected staff data fields
$query = "SELECT * FROM linked_people.person WHERE staff_status = 'a' AND person_id='$id'";
$getPerson = $connectLibstaff->query($query);
if ($getPerson->num_rows == 0) {
  header("HTTP/1.0 404 Not Found", true, 404);
  readfile("https://lib.montana.edu/error.php");
  exit();
}


// store items in array, strip out html tags, generate valid date stamp
while ($row = $getPerson->fetch_object()) {
	$person_id = stripslashes($row->person_id);
	$staff_fname = stripslashes($row->givenName);
	$staff_lname = stripslashes($row->familyName);
	$staff_name = stripslashes($row->givenName . ' ' . $row->familyName);
	$staff_title = stripslashes($row->jobTitle);
	$staff_dept = stripslashes($row->staff_dept);
	$affiliation = stripslashes($row->affiliation);
	$staff_room = stripslashes($row->staff_room);
	$staff_phone = stripslashes($row->staff_phone);
	$staff_email = stripslashes($row->staff_email);
	$staff_vita = stripslashes($row->staff_vita);
	$staff_web = stripslashes($row->staff_web);
	$staff_image = 'http://' . $server . $path . '/meta/img/photos/' . stripslashes($row->staff_image);
	$same_as = htmlentities(stripslashes($row->sameAs));
	$same_as2 = htmlentities(stripslashes($row->sameAs2));
	$staff_privacy = $row->staff_privacy;
	$staff_libcal_id = $row->staff_libcal_id;

// output to client
?>
  <rdf:Description rdf:about="<?php echo 'http://'.$server.$path.'/'.$id; ?>">
    <rdf:type rdf:resource="http://schema.org/WebPage"/>
    <schema:mainContentOfPage rdf:resource="<?php echo 'http://'.$server.$path.'/'.$id.'#person'; ?>"/>
  </rdf:Description>
  <rdf:Description rdf:about="<?php echo 'http://'.$server.$path.'/'.$id.'#person'; ?>">
    <rdf:type rdf:resource="http://schema.org/Person"/>
    <schema:address rdf:resource="<?php echo 'http://'.$server.$path.'/'.$id.'#address'; ?>"/>
    <schema:organization rdf:resource="<?php echo 'http://'.$server.$path.'/'.$id.'#organization'; ?>"/>
    <schema:name><?php echo $staff_name; ?></schema:name>
    <schema:jobTitle><?php echo $staff_title; ?></schema:jobTitle>
    <schema:telephone><?php echo $staff_phone; ?></schema:telephone>
    <schema:email><?php echo $staff_email; ?></schema:email>
    <schema:image rdf:resource="<?php echo $staff_image; ?>"/>
<?php
if (strlen($staff_web) > 3) {
?>
    <schema:url rdf:resource="<?php echo $staff_web; ?>"/>
<?php
}
?>
    <schema:primaryImageOfPage rdf:resource="<?php echo $staff_image; ?>"/>
<?php
    //request selected staff data fields
		$query = "SELECT person_id FROM linked_people.person WHERE staff_status = 'a' AND staff_dept='$staff_dept'";
    $getColleagues = $connectLibstaff->query($query);
		if ($getColleagues->num_rows == 0) {
	  	die('<p>Error retrieving colleagues data from database!<br />'.
		  'Error: ' . mysql_error() . '</p>');
		}
    while ($row = $getColleagues->fetch_object()) {
        $colleague_id = stripslashes($row->person_id);
?>
    <schema:colleague rdf:resource="<?php echo 'http://'.$server.$path; ?>/<?php echo $colleague_id; ?>"/>
<?php
    }
?>
<?php
		//get person's expertise topics
		$query = "SELECT *
		FROM linked_people.person, linked_people.create_action, linked_people.create_action_match
		WHERE person.person_id = '$id'
		AND create_action_match.create_id = create_action.create_id
		AND create_action_match.person_id = '$id'
		AND person.staff_status =  'a'";

    echo $query;

    $getPersonExpertise = $connectLibstaff->query($query);
 
    if ($getPersonExpertise->num_rows == 0) {
?>
    <schema:Specialty>No expertise or skill(s) assigned to this person.</schema:Specialty>
<?php
		}
    while ($row = $getPersonExpertise->fetch_object()) {
			$object_id = $row->create_id;
			$object = $row->object;
			$object_url = $row->object_uri;
?>
    <schema:Specialty><?php echo $object_url; ?></schema:Specialty>
<?php
    }
?>
    <schema:affiliation xml:lang="en"><?php echo $affiliation; ?></schema:affiliation>
    <schema:worksFor xml:lang="en"><?php echo $affiliation; ?></schema:worksFor>
    <schema:workLocation xml:lang="en"><?php echo $staff_dept; ?></schema:workLocation>
<?php
if (strlen($same_as) > 3 && strlen($same_as2) > 3) {
?>
    <owl:sameAs><?php echo $same_as; ?></owl:sameAs>
    <schema:sameAs rdf:resource="<?php echo $same_as; ?>"/>
    <owl:sameAs><?php echo $same_as2; ?></owl:sameAs>
    <schema:sameAs rdf:resource="<?php echo $same_as2; ?>"/>
<?php
}
if (strlen($same_as) > 3 && strlen($same_as2) < 3) {
?>
    <owl:sameAs><?php echo $same_as; ?></owl:sameAs>
    <schema:sameAs rdf:resource="<?php echo $same_as; ?>"/>
<?php
}
if (strlen($same_as2) > 3 && strlen($same_as) < 3) {
?>
    <owl:sameAs><?php echo $same_as2; ?></owl:sameAs>
    <schema:sameAs rdf:resource="<?php echo $same_as2; ?>"/>
<?php
}
?>
  </rdf:Description>
  <rdf:Description rdf:about="<?php echo 'http://'.$server.$path.'/'.$id.'#address'; ?>">
    <rdf:type rdf:resource="http://schema.org/PostalAddress"/>
    <schema:streetAddress>P.O. Box 173320, Room # <?php echo $staff_room; ?></schema:streetAddress>
    <schema:addressLocality>Bozeman</schema:addressLocality>
    <schema:addressRegion>MT</schema:addressRegion>
    <schema:postalCode>59717-3320</schema:postalCode>
  </rdf:Description>
  <rdf:Description rdf:about="<?php echo 'http://'.$server.$path.'/'.$id.'#organization'; ?>">
    <schema:member rdf:resource="<?php echo 'http://'.$server.$path.'/'.$id.'#member'; ?>"/>
    <schema:name>Montana State University (MSU) Library</schema:name>
    <schema:sameAs rdf:resource="http://www.freebase.com/m/0j3y9r1"/>
    <rdf:type rdf:resource="http://schema.org/EducationalOrganization"/>
  </rdf:Description>
  <rdf:Description rdf:about="<?php echo 'http://'.$server.$path.'/'.$id.'#member'; ?>">
    <rdf:type rdf:resource="http://schema.org/OrganizationRole"/>
    <schema:member rdf:resource="<?php echo 'http://'.$server.$path.'/'.$id.'#person'; ?>"/>
  </rdf:Description>
<?php
}
?>
</rdf:RDF>